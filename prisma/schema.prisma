 generator client {
   provider = "prisma-client-js"
 }

 datasource db {
   provider = "postgresql"
   url      = env("DATABASE_URL")
 }

 model User {
   id           String   @id @default(cuid())
   name         String
   email        String   @unique
   username     String   @unique
   passwordHash String
   image        String?
   role         Role     @default(USER)
   consentFlags Json?
   createdAt    DateTime @default(now())
   updatedAt    DateTime @updatedAt
   sessions     Session[]
   threads      Thread[]
   observations Observation[]
   alerts       Alert[]
 }

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

   @@index([userId, expiresAt])
 }

enum Role {
  USER
  ADMIN
  GUEST
}

 model Thread {
   id             String   @id @default(cuid())
   userId         String
   title          String?
   createdAt      DateTime @default(now())
   lastActivityAt DateTime @default(now())
   user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
   messages       Message[]
   predictions    Prediction[]
   alerts         Alert[]
   @@index([userId, lastActivityAt(sort: Desc)])
 }

model Message {
  id         String   @id @default(cuid())
  threadId   String
  senderType String
  text       String?
  createdAt  DateTime @default(now())
  thread     Thread   @relation(fields: [threadId], references: [id], onDelete: Cascade)
  attachments Attachment[]
  predictions Prediction[] @relation("PredictionInput")
  @@index([threadId, createdAt])
 }
 model Attachment {
   id        String   @id @default(cuid())
   messageId String
   url       String
   mime      String
   bytes     Int
   kind      String
   createdAt DateTime @default(now())
   message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
 }

 model Prediction {
   id             String   @id @default(cuid())
   threadId       String
   inputMessageId String?
   model          String
   riskScore      Int
   band           String
   factors        Json?
   recommendations Json?
   createdAt      DateTime @default(now())
   thread         Thread   @relation(fields: [threadId], references: [id], onDelete: Cascade)
   inputMessage   Message? @relation("PredictionInput", fields: [inputMessageId], references: [id])
   @@index([threadId, createdAt])
 }

 model Observation {
   id         String   @id @default(cuid())
   userId     String
   kind       String
   value      Json
   observedAt DateTime
   source     String
   user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
   @@index([userId, observedAt(sort: Desc)])
 }

 model Alert {
   id         String   @id @default(cuid())
   userId     String
   threadId   String?
   severity   String
   title      String
   body       String
   status     String   @default("open")
   createdAt  DateTime @default(now())
   resolvedAt DateTime?
   user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
   thread     Thread?  @relation(fields: [threadId], references: [id], onDelete: Cascade)
   @@index([userId, status, createdAt(sort: Desc)])
 }
